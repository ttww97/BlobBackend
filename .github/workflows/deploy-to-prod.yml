name: Deploy to Production Server

# 触发条件：当有代码 push 到 main 分支时触发
on:
  push:
    branches:
      - main  # 或者 master，根据你的主分支名修改

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 使用GitHub提供的最新Ubuntu服务器作为构建环境

    steps:
    # 第1步：检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 第2步：设置Java环境
    - name: Set up JDK 24
      uses: actions/setup-java@v3
      with:
        java-version: '24' # 根据你的项目所需Java版本修改
        distribution: 'temurin'
        cache: maven # 缓存Maven依赖，加快后续构建速度

    # 第3步：使用Maven构建项目
    - name: Build with Maven
      run: mvn -B package --file pom.xml
      # -B 表示 Batch mode，避免交互式提示
      # package 表示执行打包操作

    # 第4步：上传WAR包到你的服务器
    - name: Deploy WAR to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        source: "target/*.war"  # Maven默认的WAR包输出路径
        target: "/tmp"         # 先上传到一个临时目录

    # 第5步：在服务器上执行部署脚本
    - name: Tidy up and restart Tomcat
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        script: |
          # 执行我们预先准备好的部署脚本
          # 将 /tmp/*.war 作为参数传递给它
          /home/deployer/deploy.sh /tmp/*.war